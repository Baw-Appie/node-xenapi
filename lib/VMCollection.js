// Generated by CoffeeScript 1.8.0
(function() {
  var Promise, VMCollection, debug, _,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  debug = require('debug')('XenAPI:VMCollection');

  Promise = require('bluebird');

  _ = require('lodash');

  VMCollection = (function() {
    var VM, session;

    session = void 0;

    VM = void 0;


    /**
    	* Construct VMCollection
    	* @class
    	* @param      {Object}   session - An instance of Session
    	* @param      {Object}   VM - Dependency injection of the VM class.
     */

    function VMCollection(_session, _VM) {
      this.list = __bind(this.list, this);
      debug("constructor()");
      if (!_session) {
        throw Error("Must provide session");
      } else {
        session = _session;
      }
      if (!_VM) {
        throw Error("Must provide VM");
      } else {
        VM = _VM;
      }
    }


    /**
    	 * List all VMs
    	 * @return     {Promise}
     */

    VMCollection.prototype.list = function() {
      debug("list()");
      return new Promise((function(_this) {
        return function(resolve, reject) {
          return session.request("VM.get_all_records").then(function(value) {
            var VMs, createVMInstance;
            if (!value) {
              reject();
            }
            debug("Received " + (Object.keys(value).length) + " records");
            createVMInstance = function(vm, key) {
              if (!vm.is_a_template && !vm.is_control_domain) {
                return new VM(session, vm, key);
              }
            };
            VMs = _.map(value, createVMInstance);
            return resolve(_.filter(VMs, function(vm) {
              return vm;
            }));
          })["catch"](function(e) {
            debug(e);
            return reject(e);
          });
        };
      })(this));
    };

    return VMCollection;

  })();

  module.exports = VMCollection;

}).call(this);
